
<html>
<head>
    <title>Traces Dayview</title>
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/flick/jquery-ui.css">
    <style type="text/css">    
				body{
            font-family: 'helvetica neue', 'helvetica', sans-serif;
            background-color: white;
        }
        h1{
            font-size: 2em;
            font-weight: 300;
        }
        #datepicker{
            padding: 5px 10px 5px;
            margin: 0px 10px 10px 0px;
            width: 250px;
            float: left;
            font-family: 'helvetica neue', 'helvetica', sans-serif;
            font-size: 1.5em;
            font-weight: 300;
            background-color: white;
            color: gray;
            border-width: 1px;
            border-color: white;
            border-style: solid;
        }	
    
        .axis text {
            font: 12px sans-serif;
            fill: black;
        }
        .axis line{
            fill: none;
            stroke: #999;
            shape-rendering: crispEdges;
        }
        .axis path {
/*            display: none;*/
        }
				
				.main{
/*					background:gray;*/
				}		
        .timelineBackground{
            fill: #BBB;
            shape-rendering: crispEdges;
        }
				
        .bar{
            stroke-width: 1px;
            shape-rendering: crispEdges;
        }
				.tooltip{
				    padding: 4px;
				    position: absolute;
				    background-color: #CCC;
						visibility:hidden;
				}
				
    </style>
</head>
<body>
    <input type="text" id="datepicker">
    <p>Summary statistics can go up here</p>

    <script type="text/javascript">
		
		//set dimensions 
		var m = [12, 12, 12, 75]; //top right bottom left  margins
    var w = window.innerWidth - m[1] - m[3]; //replace with actual window width
  //  var h = 500 - m[0] - m[2]; //replace with actual window height
    var barHeight = 24;
    var cHeight = 50; //height of compressed timeline
		var eHeight = 500; //height of expanded timeline
				
		//set styling			
    var timelineColors = ['#4394F7','#60B632','#EE7C15','#A24DDA','#F2CC20', '#E4454C']
			
    //render datepicker
    $( "#datepicker" ).datepicker({dateFormat: "MM d, yy", onSelect: function(date) {
			renderTimeline();}
    });
    $( "#datepicker" ).datepicker("setDate", "0");
		
		// add container for tooltip
		var tooltip = d3.select("body").append("div")
    			.attr("class", "tooltip");
		
		//add main display svg
		var main = d3.select("body")
           .append("svg")
           .attr("width", w + m[1] + m[3])
           .attr("height", cHeight + eHeight + m[0] + m[2])
           .attr("class", "main");
		
		//add container for main compressed timeline
		var cTimeline = main.append("g")
           .attr("transform", "translate(" + m[3] + ",0)")//start @ x = 75
           .attr("width", w)
           .attr("height", cHeight)
           .attr("class", "cTimeline");
				
		//background rectangle for compressed timeline	
		var cTimelineBackground = cTimeline.append("rect")
				   .attr("x", m[3])
				   .attr("y", 0)
				   .attr("height", barHeight)
				   .attr("width", w)
				   .attr('class', 'timelineBackground');
			
			
		//add container for expanded timeline
		var eTimeline = main.append("g")
            .attr("transform", "translate(" + m[3] + "," + (cHeight + m[0]) + ")")//start @ x = 75, y = under cTimeline
            .attr("width", w)
            .attr("height", eHeight)
            .attr("class", "eTimeline");
						
	
	
		function renderTimeline(){
      
			//get start and end time of day we are viewing
			selectedDate = $( "#datepicker" ).datepicker("getDate");
			timeBegin = Date.parse(selectedDate)/1000.0 + selectedDate.getTimezoneOffset()*60.0;
			timeEnd = timeBegin + 24*60*60; //show one day of data
			
			console.log("timeBegin: "+timeBegin);
			console.log("timeEnd: "+ timeEnd);
									
			//set scale
			var x = d3.scale.linear()
      		 	.domain([timeBegin, timeEnd]) //sets the scale's input domain to the specified array of numbers
						.range([m[3],w]);  //sets the scale's output range to the specified array of values
		
		
			//test input value with raw
			console.log("x(timeBegin): "+ x(timeBegin));
			console.log("x(timeEnd): "+ x(timeEnd));			
			
			d3.json("extract.json", function(error, json) 
			{
          if (error) return console.warn(error);

          // get the data for today
          data = json;
          filteredData = data['appevents'].filter(function (el) {
              return (el.start <= timeEnd && el.start >= timeBegin) ||
              (el.end <= timeEnd && el.end >= timeBegin);
          });
					
      		//draw timeline axis--------------------------
      		var t1 = selectedDate;
      		var t2 = new Date(t1.getTime());
      				t2.setDate(t2.getDate() + 1);
		
							console.log("t1 :" +t1);
							console.log("t2 :" +t1);
							
							console.log("t1.getTime"+ t1.getTime());							
							console.log("t2.getTime"+ t2.getTime());							
		
      		var xScale = d3.time.scale()
      		    .domain([t1, t2])
      		    .range([m[3], w]);
							
      		var xAxis = d3.svg.axis()
      		    .scale(xScale)
      		    .orient("bottom");
		
      		d3.selectAll(".axis")
      				.remove(); //remove existing axis so it can be redrawn 
		
					main.append("g") //draw the timeline axis
      		    .attr("class", "axis")
      		    .attr("transform", "translate("+m[3]+"," + barHeight + ")")							
      		    .call(xAxis)
      		  .selectAll("text") //add timeline axis text
      		    .attr("y", 8)
      		    .attr("x", 0)
      		    .style("text-anchor", "center");

					//draw compressed timeline---------------------------------
      		cTimeline.selectAll("g")
      				.remove(); //remove bars forredraw 
		
					cbars = cTimeline.append("g").selectAll(".cbar")
              .data(filteredData);
							
          cbars.enter().append("rect")
              .attr("class", 'cbar')
              .attr("x", function(d) {return x(d.start);})   //x = scaled value of start time
              .attr("y", 0)

  						.attr("width", function(d) {return ( x(d.end) - x(d.start)); }) //x = value of scaled(end) - scaled(start)
              
							.attr("height", barHeight)
              .style("fill", function(d){return timelineColors[d.appid % 6]})
							.on("mouseover", function(d) {
                  tooltip.html(d.appid)
                      .style("left", (d3.event.pageX) + "px")
                      .style("top", (d3.event.pageY - 28) + "px")
                      .style("visibility", "visible"); })
              .on("mousemove", function(d) {
                  tooltip.style("left", (d3.event.pageX) + "px")
                      .style("top", (d3.event.pageY - 28) + "px"); })
              .on("mouseout", function(d) {
								tooltip.style("visibility", "hidden");});		

					cbars.exit().remove();
					
					//draw expanded timeline---------------------------------
					lanes = json["apps"];
			    items = json["appevents"];
					laneLength = lanes.length;
					
	 				// x = d3.scale.linear()
	 				// 		.domain([timeBegin, timeEnd])
	 				// 		.range([0, w]);
   				
	 				x1 = d3.scale.linear()
	 						.range([0, w]);
							// .range([m[3],w]);
   				
	 				y1 = d3.scale.linear()
	 						.domain([0, laneLength])
	 						.range([0, eHeight]);
   				
	 				y2 = d3.scale.linear()
	 						.domain([0, laneLength])
	 						.range([0, eHeight]);
							
      		eTimeline.selectAll("g")
      				.remove(); //remove everything in eTimeline for redraw
							
					eTimeline.append("g").selectAll(".laneLine")
	    		    .data(items)
	    		    .enter().append("line")
	    		    .attr("x1", m[3])
	    		    .attr("y1", function(d) {return y1(d.appid);})
	    		    .attr("x2", w)
	    		    .attr("y2", function(d) {return y1(d.appid);})
	    		    .attr("stroke", "lightgray")
							.attr("class","laneLine");
      							
	    		eTimeline.append("g").selectAll(".laneText")
	    		    .data(lanes)
	    		    .enter().append("text")
	    		    .text(function(d) {return d.name;})
	    		    .attr("x", m[3])
	    		    .attr("y", function(d, i) {return y1(i + .5);})
	    		    .attr("dy", ".5ex")
	    		    .attr("text-anchor", "end")
							.style("font-size", function(d) {
								return (Math.min( 12, Math.min(m[3], (m[3] - 8) / this.getComputedTextLength() * 24)))+ "px"; })	//scale font-size to fit in margin
	    		    .attr("class", "laneText");		
									
      		ebars = eTimeline.append("g").selectAll(".ebar")
          		.data(filteredData, function(d) { return d.id; });
					
      		ebars.enter().append("rect")
              .attr("class","ebar")
						  .style("fill", function(d) {return timelineColors[d.appid % 6]})
              .attr("y", function(d) {return y1(d.appid) + 10;})
							.attr("x", function(d) {return x(d.start);})
							
							// .attr("width", function(d) {return x(timeBegin + d.end - d.start);}) //from original
  						.attr("width", function(d) {return ( x(d.end) - x(d.start)); }) //x = value of scaled(end) - scaled(start)

							.attr("height", function(d) {return .7 * y1(1);})
          		.on("mouseover", function(d) {
              		tooltip.html(d.id)
                  		.style("left", (d3.event.pageX) + "px")
                  		.style("top", (d3.event.pageY - 28) + "px")
                  		.style("visibility", "visible"); })
          		.on("mousemove", function(d) {
              		tooltip.style("left", (d3.event.pageX) + "px")
                  		.style("top", (d3.event.pageY - 28) + "px"); })
          		.on("mouseout", function(d) {
								tooltip.style("visibility", "hidden"); });	  
					
					ebars.exit().remove();
			});	//end d3.json
		}//end renderTimeline()
		
				
		</script>

</body>
</html>
